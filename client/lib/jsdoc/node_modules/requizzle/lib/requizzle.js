/*
	Copyright (c) 2014 Google Inc. All rights reserved.
	Copyright (c) 2012-2013 Johannes Ewald.

	Use of this source code is governed by the MIT License, available in this package's LICENSE file
	or at http://opensource.org/licenses/MIT.
***REMOVED***
'use strict';

***REMOVED*** @module lib/requizzle***REMOVED***

var _ = require('underscore');
var loader = require('./loader');
var Module = require('module');
var path = require('path');

***REMOVED***
***REMOVED*** Function that returns text to swizzle into the module.
***REMOVED***
***REMOVED*** @typedef module:lib/requizzle~wrapperFunction
***REMOVED*** @type {function}
***REMOVED*** @param {string} targetPath - The path to the target module.
***REMOVED*** @param {string} parentModulePath - The path to the module that is requiring the target module.
***REMOVED*** @return {string} The text to insert before or after the module's source code.
***REMOVED***

***REMOVED***
***REMOVED*** Options for the wrappers that will be swizzled into the target module.
***REMOVED***
***REMOVED*** @typedef module:lib/requizzle~options
***REMOVED*** @type {Object}
***REMOVED*** @property {Object=} options.extras - Functions that generate text to swizzle into the target
***REMOVED*** module.
***REMOVED*** @property {module:lib/requizzle~wrapperFunction} options.extras.after - Function that returns
***REMOVED*** text to insert after the module's source code.
***REMOVED*** @property {module:lib/requizzle~wrapperFunction} options.extras.before - Function that returns
***REMOVED*** text to insert before the module's source code.
***REMOVED*** @property {(Array.<string>|string)} options.requirePaths - Additional paths to search when
***REMOVED*** resolving module paths in the target module.
***REMOVED***

function isNativeModule(targetPath, parentModule) {
	var lookupPaths = Module._resolveLookupPaths(targetPath, parentModule);

	if (lookupPaths[0] === targetPath && lookupPaths[1].length === 0) {
		return true;
	}

	return false;
}

***REMOVED***
***REMOVED*** Create a `Requizzle` instance. If you provide options, Requizzle will default to those options
***REMOVED*** when you call {@link Requizzle#requizzle}.
***REMOVED***
***REMOVED*** @class
***REMOVED*** @param {!module:lib/requizzle~options} options - Options for the wrappers that will be swizzled
***REMOVED*** into the target module.
***REMOVED*** @param {Object=} cache - For internal use.
***REMOVED***
function Requizzle(options, cache) {
	this._options = options;
	this._cache = cache || {
		module: {},
		source: {}
	***REMOVED***
}

***REMOVED***
***REMOVED*** Load the module, swizzling in the requested changes.
***REMOVED***
***REMOVED*** @param {!string} targetPath - The path to the module that will be loaded.
***REMOVED*** @return {Module} The swizzled module.
***REMOVED***
Requizzle.prototype.requizzle = function requizzle(targetPath) {
	var options = this._options;
	var parentModule = options.parent;
	var targetModule;
	var wrapper;

	// Don't interfere with native modules
	if (isNativeModule(targetPath, parentModule)) {
		return require(targetPath);
	}

	// Resolve the filename relative to the parent module
	targetPath = Module._resolveFilename(targetPath, parentModule);

	wrapper = loader.createWrapper(targetPath, parentModule, this._cache, this._options);
	targetModule = loader.load(targetPath, parentModule, wrapper, this._cache, this._options);

	return targetModule.exports;
***REMOVED***

module.exports = Requizzle;
