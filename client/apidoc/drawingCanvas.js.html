<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: drawing/drawingCanvas.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: drawing/drawingCanvas.js</h1>

    


    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileoverview A class representing a drawing canvas.
 */

goog.provide('xrx.drawing.Canvas');



goog.require('goog.dom.DomHelper');
goog.require('goog.dom.ViewportSizeMonitor');
goog.require('goog.events');
goog.require('goog.events.EventType');
goog.require('goog.math.AffineTransform');
goog.require('goog.net.ImageLoader');
goog.require('xrx');
goog.require('xrx.drawing');
goog.require('xrx.drawing.GroupBackground');
goog.require('xrx.drawing.GroupShape');
goog.require('xrx.drawing.GroupShapeCreate');
goog.require('xrx.drawing.GroupShapeModify');
goog.require('xrx.drawing.Mode');
goog.require('xrx.drawing.Shield');
goog.require('xrx.drawing.State');
goog.require('xrx.graphics.Engine');
goog.require('xrx.graphics.Graphics');



/**
 * A class representing a drawing canvas. The canvas can have a background
 * image and thereby can serve as an image annotation tool.
 *
 * @param {DOMElement} element The HTML element used to install the canvas.
 * @param {string} The name of the rendering engine.
 * @see xrx.graphics.Engine
 * @constructor
 */
xrx.drawing.Canvas = function(element, opt_engine) {

  /**
   * The graphics engine.
   * @type {string}
   * @private
   */
  var name = opt_engine || xrx.graphics.Engine.SVG;
  this.graphics_ = goog.getObjectByName('xrx.' + name);

  /**
   * The DOM element used to install the canvas.
   * @type {DOMElement}
   * @private
   */
  this.element_ = element;

  /**
   * The root element of the canvas.
   * @type {DOMElement}
   * @private
   */
  this.elementCanvas_;

  /**
   * @type {DOMElement}
   * @private
   */
  this.groupBackground_;

   /**
   * @type {DOMElement}
   * @private
   */
  this.groupShape_;
  
  /**
   * @type {DOMElement}
   * @private
   */
  this.groupShapeModify_;

  /**
   * @type {DOMElement}
   * @private
   */
  this.groupShapeCreate_;

  /**
   * @type {number}
   * @private
   */
  this.state = xrx.drawing.State.NONE;

  /**
   * @type {number}
   * @private
   */
  this.mode_ = xrx.drawing.Mode.PAN;

  /**
   * The shape currently selected by the user.
   * @type {Object}
   * @private
   */
  this.selected_ = {
    shape: null,
    element: null
  };

  /**
   * The shape currently dragged by the user.
   * @type {Object}
   * @private
   */
  this.dragged_ = {
    element: null,
    mousePoint: null,
    coords: null
  };

  /**
   * The shape currently created by the user.
   * @type {Object}
   * @private
   */
  this.created_ = {
    shape: null
  };

  /**
   * The background image of the canvas.
   * @type {Object}
   * @private
   */
   this.image_ = {
     object: null,
     element: null
   };

  /**
   * The view-box of the canvas.
   * @type {Object}
   * @private
   */
  this.viewbox_ = {
    centerPoint: null,
    ctm: new goog.math.AffineTransform(),
    box: {
      x: 0,
      y: 0,
      x2: 0,
      y2: 0,
      width: 0,
      height: 0
    }
  };

  // install the canvas
  this.install_();
};



xrx.drawing.Canvas.prototype.getWidth = function() {
  return this.getElement().offsetWidth;
};



xrx.drawing.Canvas.prototype.getHeight = function() {
  return this.getElement().offsetHeight;
};



/**
 * Returns the engine used for rendering.
 * @see xrx.graphics.Engine
 * @return {Object} The rendering engine.
 */
xrx.drawing.Canvas.prototype.getGraphics = function() {
  return this.graphics_;
};




/**
 * Returns the current state of the canvas.
 * @see xrx.drawing.State
 * @return {number}
 */
xrx.drawing.Canvas.prototype.getState = function() {
  return this.state ? this.state : xrx.drawing.State.NONE;
};



/**
 * Sets the current state of the canvas.
 * @see xrx.drawing.State
 * @param {number} state The state.
 */
xrx.drawing.Canvas.prototype.setState = function(state) {
  state ? this.state = state : this.state = xrx.drawing.State.NONE;
};



/**
 * Returns the class of the shape which is currently selected.
 * @return {?}
 */
xrx.drawing.Canvas.prototype.getSelectedShape = function() {
  return this.selected_.shape;
};



/**
 * Sets the class of a shape as the currently selected.
 * @param {?} shape The rendered shape.
 */
xrx.drawing.Canvas.prototype.setSelectedShape = function(shape) {
  this.selected_.shape = shape;
};



/**
 * Returns the rendered shape which is currently selected.
 * @return {DOMElement} The rendered shape.
 */
xrx.drawing.Canvas.prototype.getSelectedElement = function() {
  return this.selected_.element;
};



/**
 * Sets a rendered shape as the currently selected.
 * @param {DOMElement} element The shape element.
 */
xrx.drawing.Canvas.prototype.setSelectedElement = function(element) {
  this.selected_.element = element;
};



/**
 * Returns the rendered shape which is currently dragged.
 * @return {DOMElement}
 */
xrx.drawing.Canvas.prototype.getDragElement = function() {
  return this.dragged_.element;
};



/**
 * Sets a rendered shape as the currently dragged.
 * @param {DOMElement} element The element.
 */
xrx.drawing.Canvas.prototype.setDragElement = function(element) {
  this.dragged_.element = element;
};



/**
 * Returns the mouse point where dragging started.
 * @return {Array.&lt;number>} The mouse point. 
 */
xrx.drawing.Canvas.prototype.getDragMousePoint = function() {
  if (!this.dragged_.mousePoint) this.dragged_.mousePoint = new Array(2);

  return this.dragged_.mousePoint;
};



/**
 * Keeps the mouse point where dragging started.
 * @param {Array.&lt;number>} point The mouse point. 
 */
xrx.drawing.Canvas.prototype.setDragMousePoint = function(point) {
  this.dragged_.mousePoint = point;
};



/**
 * Returns the original coordinates of the shape before dragging.
 * @return {Array.&lt;number>} The original coordinates. 
 */
xrx.drawing.Canvas.prototype.getDragCoords = function() {
  return this.dragged_.coords;
};



/**
 * Keeps the original coordinates of the shape before dragging.
 * @param {Array.&lt;number>} The actual coordinates. 
 */
xrx.drawing.Canvas.prototype.setDragCoords = function(coords) {
  this.dragged_.coords = coords;
};



/**
 * Returns the wrapper element around the canvas.
 * @return {DOMElement} The wrapper.
 */
xrx.drawing.Canvas.prototype.getElement = function() {
  return this.element_;
};



/**
 * Returns the root element of the canvas.
 * @return {DOMElement} The root element.
 */
xrx.drawing.Canvas.prototype.getElementCanvas = function() {
  return this.elementCanvas_;
};



/**
 * Returns the background group of the canvas.
 * @return {DOMElement} The element representing the background group.
 */
xrx.drawing.Canvas.prototype.getGroupBackground = function() {
  return this.groupBackground_;
};



/**
 * Returns the group of the canvas where shapes are rendered.
 * @return {DOMElement} The element representing the shape group.
 */
xrx.drawing.Canvas.prototype.getGroupShape = function() {
  return this.groupShape_;
};



/**
 * Returns the group of the canvas where shapes can be modified.
 * @return {DOMElement} The element representing the shape modify group.
 */
xrx.drawing.Canvas.prototype.getGroupShapeModify = function() {
  return this.groupShapeModify_;
};



/**
 * Returns the group of the canvas where new shapes can be drawn.
 * @return {DOMElement} The element representing the shape create group.
 */
xrx.drawing.Canvas.prototype.getGroupShapeCreate = function() {
  return this.groupShapeCreate_;
};



/**
 * Returns the DOM element of the background image.
 * @return {DOMElement} The DOM element.
 */
xrx.drawing.Canvas.prototype.getImageElement = function() {
  return this.image_.element;
};



/**
 * Returns the URL of the current background image.
 * @return {string} The URL.
 */
xrx.drawing.Canvas.prototype.getImageUrl = function() {
  return '../data/SachsenspiegelHeidelberg/Bilder-34553-28167-1600.jpg';
};



/**
 * Returns the current background image object.
 * @return {Image} The image object. 
 */
xrx.drawing.Canvas.prototype.getImage = function() {
  return this.image_.object;
};



/**
 * Returns the view-box of the canvas.
 * @return {Object} The view-box.
 */
xrx.drawing.Canvas.prototype.getViewBox = function() {
  return this.viewbox_;
};



/**
 * Returns all groups of the canvas as an array.
 * @return {Array} The layers.
 */
xrx.drawing.Canvas.prototype.getGroups = function() {
  return [this.groupBackground_, this.groupShape_, this.groupShapeModify_,
      this.groupShapeCreate_];
};



/**
 * Deactivates all shields of the canvas.
 */
xrx.drawing.Canvas.prototype.shieldsDeactivate = function() {
  var groups = this.getGroups();
  for (var i = 0, len = groups.length; i &lt; len; i++) {
    groups[i].getShield().deactivate();
  }
};



/**
 * Whether a point is inside the current view-box.
 * @param {Array.&lt;number>} point The point.
 */
xrx.drawing.Canvas.prototype.isValidPoint = function(point) {
  return point[0] >= this.viewbox_.box.x &amp;&amp; point[0] &lt;= this.viewbox_.box.x2 &amp;&amp;
      point[1] >= this.viewbox_.box.y &amp;&amp; point[1] &lt;= this.viewbox_.box.y2;
};



/**
 * Whether the bounding box of a shape is inside the current view-box.
 * @param {Object} bbox The bounding box.
 */
xrx.drawing.Canvas.prototype.isValidBBox = function(bbox) {
  return bbox.x >= this.viewbox_.box.x &amp;&amp; bbox.x2 &lt;= this.viewbox_.box.x2 &amp;&amp;
      bbox.y >= this.viewbox_.box.y &amp;&amp; bbox.y2 &lt;= this.viewbox_.box.y2;
};



/**
 * Returns the current transformation matrix of the view-port.
 * @return {goog.math.AffineTransform}
 */
xrx.drawing.Canvas.prototype.getCTM = function() {
  return this.getGraphics().getCTM(this.getImageElement());
};



/**
 * Returns the current transformation matrix of the canvas.
 * @return {goog.math.AffineTransform}
 */
xrx.drawing.Canvas.prototype.setCTM = function(matrix) {
  this.getGraphics().setCTM(this.getImageElement(), matrix);
  this.getGraphics().setCTM(this.groupShape_.getElement(), matrix);
  this.getGraphics().setCTM(this.groupShapeModify_.getElement(), matrix);
  this.getGraphics().setCTM(this.groupShapeCreate_.getElement(), matrix);
};



xrx.drawing.Canvas.prototype.setMode = function(mode) {
  this.mode_ = mode;
};



xrx.drawing.Canvas.prototype.handleResize = function() {
  var width = this.getElement().offsetWidth;
  var height = this.getElement().offsetHeight;
  this.elementCanvas_.setAttribute('width', width);
  this.elementCanvas_.setAttribute('height', height);
  this.groupBackground_.handleResize(size, width, height);
  // TODO: handler other groups
};



/**
 * @private
 */
xrx.drawing.Canvas.prototype.installCanvas_ = function(image) {
  var self = this;
  var vsm = new goog.dom.ViewportSizeMonitor();
  goog.events.listen(vsm, goog.events.EventType.RESIZE, function(e) {
    self.handleResize();
  }, false, self);

  this.elementCanvas_ = this.getGraphics().Canvas.create();
  this.getGraphics().Canvas.setHeight(this.elementCanvas_, this.getHeight());
  this.getGraphics().Canvas.setWidth(this.elementCanvas_, this.getWidth());
  goog.dom.append(this.element_, this.elementCanvas_);
};



/**
 * @private
 */
xrx.drawing.Canvas.prototype.installGroupBackground_ = function(image) {
  this.groupBackground_ = new xrx.drawing.GroupBackground(this);
  goog.dom.append(this.elementCanvas_, this.groupBackground_.getElement());
};



/**
 * @private
 */
xrx.drawing.Canvas.prototype.installGroupShape_ = function() {
  this.groupShape_ = new xrx.drawing.GroupShape(this);
  goog.dom.append(this.elementCanvas_, this.groupShape_.getElement());
};



/**
 * @private
 */
xrx.drawing.Canvas.prototype.installGroupShapeModify_ = function(image) {
  this.groupShapeModify_ = new xrx.drawing.GroupShapeModify(this);
  goog.dom.append(this.elementCanvas_, this.groupShapeModify_.getElement());
};



/**
 * @private
 */
xrx.drawing.Canvas.prototype.installGroupShapeCreate_ = function(image) {
  this.groupShapeCreate_ = new xrx.drawing.GroupShapeCreate(this);
  goog.dom.append(this.elementCanvas_, this.groupShapeCreate_.getElement());
};



/**
 * @private
 */
xrx.drawing.Canvas.prototype.install_ = function() {
  var self = this;
  var imageLoader = new goog.net.ImageLoader();
  var dummyImage = goog.dom.createElement('img');
  dummyImage.id = '_dummy';
  dummyImage.src = this.getImageUrl();

  goog.events.listen(imageLoader, goog.events.EventType.LOAD, function(e) {
    self.image_.object = e.target;

    // install the canvas
    self.installCanvas_(self.image_.object);

    // install groups
    self.installGroupBackground_(self.image_.object);
    self.installGroupShape_();
    self.installGroupShapeModify_(self.image_.object);
    self.installGroupShapeCreate_(self.image_.object);

    // initialize the center point
    self.viewbox_.centerPoint = [self.image_.object.naturalWidth / 2, self.image_.object.naturalHeight / 2];

    // initialize the bounding box
    self.viewbox_.box.x2 = self.image_.object.naturalWidth;
    self.viewbox_.box.y2 = self.image_.object.naturalHeight;
    self.viewbox_.box.width = self.image_.object.naturalWidth;
    self.viewbox_.box.height = self.image_.object.naturalHeight;
  });

  imageLoader.addImage('_dummy', dummyImage);
  imageLoader.start();
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Classes</h3><ul><li><a href="xrx.drawing.html">drawing</a></li><li><a href="xrx.drawing.Canvas.html">Canvas</a></li><li><a href="xrx.drawing.Group.html">Group</a></li><li><a href="xrx.drawing.GroupBackground.html">GroupBackground</a></li><li><a href="xrx.drawing.GroupShape.html">GroupShape</a></li><li><a href="xrx.drawing.GroupShapeCreate.html">GroupShapeCreate</a></li><li><a href="xrx.drawing.GroupShapeModify.html">GroupShapeModify</a></li><li><a href="xrx.drawing.Shield.html">Shield</a></li><li><a href="xrx.drawing.Toolbar.html">Toolbar</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-dev</a> on Thu Jun 19 2014 16:53:36 GMT+0200 (MESZ)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
